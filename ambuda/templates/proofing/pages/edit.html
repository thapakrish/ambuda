{% extends 'header-main-footer.html' %}
{% import "macros/proofing.html" as m %}
{% import "macros/components.html" as mc %}


{# Render a radiobutton as a clickable button. #}
{% macro _status(field, peer_classes) %}
{# Use wrapping div so that we can use the Tailwind "peer" class. #}
<div>
  {{ field(class_="hidden peer") }}
  {{ field.label(class_="block border rounded p-2 mr-4
  text-slate-700 border-slate-300 hover:bg-slate-300 "
  + peer_classes
  + " peer-checked:font-bold cursor-pointer") }}
</div>
{% endmacro %}


{% set button_css = "block p-1 px-2 hover:bg-slate-700" %}
{% macro _dropdown_button(slug, name) %}
<button class="{{ button_css }}"
   @mousedown.prevent="toggleMenu('{{ slug }}')"
   @mouseenter="hoverMenu('{{ slug }}')">{{ name }}</button>
{% endmacro %}

{% macro _dropdown_pane(slug) %}
<div x-show="activeMenu === '{{ slug }}'" @mousedown.outside="activeMenu = null" class="dropdown-pane w-48">
  <ul class="text-sm" @click.prevent="activeMenu = null">
    {{ caller() }}
  </ul>
</div>
{% endmacro %}

{% macro _dropdown_item(fn, text) -%}
<li><button class="dropdown-item" @mouseup.prevent="{{ fn }}">{{ text|safe }}</button></li>
{%- endmacro %}


{% macro _dropdown_separator() %}
<li class="border-t border-slate-700 my-1"></li>
{% endmacro %}


{% macro _latin_char_row(chars, class) %}
<div class="grid {{ class }}">
{%- for char in chars.split() %}
  <button class="hover:bg-sky-500 rounded p-1">{{ char.upper()|safe }}</button>
  <button class="hover:bg-sky-500 rounded p-1">{{ char|safe }}</button>
{%- endfor %}
</div>
{% endmacro %}


{% macro _devanagari_char_row(chars, class) %}
<div class="text-xl grid {{ class }}">
{% for char in chars.split() %}
  <button class="hover:bg-sky-500 rounded p-1">{{ char|safe }}</button>
{% endfor %}
</div>
{% endmacro %}


{% block title %}Edit: {{ project.display_title }}/{{ cur.slug }} | Ambuda{% endblock %}

<style>
  [x-cloak] { display: none !important; }
</style>

{% block header %}{% endblock %}
{% block footer %}{% endblock %}
{% block main %}
{# Loading overlay shown while Alpine.js initializes #}
<div id="editor-loading" class="h-screen flex items-center justify-center bg-slate-50">
  <div class="text-center">
    <div class="text-lg text-slate-600 mb-2">{{ _('Loading editor...') }}</div>
    <div class="text-sm text-slate-400">{{ _('Please wait') }}</div>
  </div>
</div>

<div class="h-screen flex flex-col overflow-hidden" x-data="proofer" x-init="document.getElementById('editor-loading').style.display = 'none'" x-cloak @keydown.window="if (($event.metaKey || $event.ctrlKey) && $event.key === 'k') { $event.preventDefault(); openCommandPalette(); }">

  {# Command menu: edit, view, tools, ... #}
  {% set button_css = "block p-1 px-2 hover:bg-slate-700" %}
  <nav class="bg-slate-900 text-white text-sm flex justify-between px-2" x-data="{
    activeMenu: null,
    toggleMenu(name) { this.activeMenu = (this.activeMenu === name ? null : name) },
    hoverMenu(name) { if (this.activeMenu) this.activeMenu = name }
  }">
    {# Left-aligned (standard commands) #}
    <div class="flex">

    <div class="relative">
      {{ _dropdown_button('page', _('Page')) }}
      {% call _dropdown_pane('page') %}
        {{ _dropdown_item('copyPageXML', _('Copy page XML')) }}
      {% endcall %}
    </div>

    <div class="relative">
      {{ _dropdown_button('edit', _('Edit')) }}
      {% call _dropdown_pane('edit') %}
        {{ _dropdown_item('undo', _('Undo')) }}
        {{ _dropdown_item('redo', _('Redo')) }}
        {{ _dropdown_separator() }}
        {{ _dropdown_item('insertBlock', _('Insert block')) }}
        {{ _dropdown_item('deleteBlock', _('Delete active block')) }}
        {{ _dropdown_item('moveBlockUp', _('Move block up')) }}
        {{ _dropdown_item('moveBlockDown', _('Move block down')) }}
        {{ _dropdown_separator() }}
        {# IMPORTANT: Keep in sync with marks-config.ts
           These mark commands are available in the command palette (Cmd+K)
           which is generated automatically from marks-config.ts.
           TODO: Consider generating this menu dynamically from INLINE_MARKS #}
        {{ _dropdown_item("toggleMark('error')", _('Mark as error')) }}
        {{ _dropdown_item("toggleMark('fix')", _('Mark as fix')) }}
        {{ _dropdown_item("toggleMark('flag')", _('Mark as unclear')) }}
        {{ _dropdown_item("toggleMark('ref')", _('Mark as footnote number')) }}
        {{ _dropdown_item("toggleMark('stage')", _('Mark as stage direction')) }}
        {{ _dropdown_item("toggleMark('speaker')", _('Mark as speaker')) }}
        {{ _dropdown_item("toggleMark('chaya')", _('Mark as chaya (gloss)')) }}
        {{ _dropdown_item("toggleMark('prakrit')", _('Mark as prakrit (glossed)')) }}
      {% endcall %}
    </div>

    <div class="relative">
      {{ _dropdown_button('view', _('View')) }}
      {% call _dropdown_pane('view') %}
        {{ _dropdown_item('openCommandPalette', _('Command palette')) }}
        {{ _dropdown_separator() }}
        {{ _dropdown_item('displayImageOnLeft', _('Show image on left')) }}
        {{ _dropdown_item('displayImageOnRight', _('Show image on right')) }}
        {{ _dropdown_item('displayImageOnTop', _('Show image on top')) }}
        {{ _dropdown_item('displayImageOnBottom', _('Show image on bottom')) }}
        {{ _dropdown_separator() }}
        {{ _dropdown_item('displayVisualView', _('Switch to visual editor')) }}
        {{ _dropdown_item('displayXMLView', _('Switch to XML editor')) }}
        {{ _dropdown_separator() }}
        <li>
          <button class="dropdown-item" @click.prevent="toggleAdvancedOptions">
            <span x-show="!showAdvancedOptions">{{ _('Show advanced options') }}</span>
            <span x-show="showAdvancedOptions">{{ _('Hide advanced options') }}</span>
          </button>
        </li>
      {% endcall %}
    </div>

    <div class="relative">
      {{ _dropdown_button('tools', _('Tools')) }}
      {% call _dropdown_pane('tools') %}
        <li>
          <button class="dropdown-item"
                  @click.prevent="runOCR"
                  :disabled="isRunningOCR"
                  x-text="isRunningOCR ? '{{ _("Running OCR ...") }}' : '{{ _("Run OCR") }}'">
          </button>
        </li>
        {% if current_user is defined and current_user.is_authenticated and current_user.is_p2 %}
        <li>
          <button class="dropdown-item"
                  @click.prevent="runLLMStructuring"
                  :disabled="isRunningLLMStructuring"
                  x-text="isRunningLLMStructuring ? '{{ _("Running LLM Structuring ...") }}' : '{{ _("Run LLM Structuring") }}'">
          </button>
        </li>
        {% endif %}
        {{ _dropdown_item('openNormalizeModal', _('Normalize...')) }}
        {{ _dropdown_item('openTransliterateModal', _('Transliterate...')) }}
        {{ _dropdown_item('openAutoStructureModal', _('Auto-structure...')) }}
      {% endcall %}
    </div>

    <div class="relative">
       {# i18n: Selection menu for Unicode character in proofing editor. #}
      {{ _dropdown_button('characters', _('Characters')) }}
      <div x-show="activeMenu === 'characters'" @mousedown.outside="activeMenu = null" class="p-2 dropdown-pane w-60" @click.prevent="copyCharacter">
        <p class="text-xs text-center mb-2">{{ _('Click a character to copy it.') }}</p>
        <ul class="text-center">
          {{ _latin_char_row('ā á â à', 'grid-cols-8') }}
          {{ _latin_char_row('ī í î ì', 'grid-cols-8') }}
          {{ _latin_char_row('ū ú û ù', 'grid-cols-8') }}
          {{ _latin_char_row('ṛ ṝ ḷ ḹ', 'grid-cols-8') }}
          {{ _latin_char_row('ē é ê è', 'grid-cols-8') }}
          {{ _latin_char_row('ō ó ô ò', 'grid-cols-8') }}
          {{ _latin_char_row('ḥ ṁ ṃ', 'grid-cols-6') }}
          {{ _latin_char_row('ṅ ñ ṇ', 'grid-cols-6') }}
          {{ _latin_char_row('ṭ ḍ ś ṣ ç', 'grid-cols-10') }}
          {{ _devanagari_char_row('&#x0964; &#x0965; &#x093d; &#x0970; &#xa8f2; &#xa8f3;',
              'grid-cols-6') }}
        </ul>
      </div>
    </div>

    {% set history_url = url_for("proofing.page.history", project_slug=project.slug, page_slug=page_context.cur.slug) %}
    <div class="relative">
      {{ _dropdown_button('history', pgettext('editor', 'History')) }}
      {% call _dropdown_pane('history') %}
        {{ _dropdown_item('openHistoryModal', _('Show all history')) }}
      {% endcall %}
    </div>

    <div class="relative">
      {{ _dropdown_button('help', pgettext('editor', 'Help')) }}
      <div x-show="activeMenu === 'help'" @mousedown.outside="activeMenu = null" class="dropdown-pane w-48">
        <a href="{{ url_for("proofing.guidelines") }}" target="_blank" class="dropdown-item">
          {{ _('Proofing guidelines') }}
        </a>
      </div>
    </div>
    </div>

    {# Right-aligned (username, sign in) #}
    <div>
      {% if current_user.is_authenticated %}
      {% set name = current_user.username %}
      <div class="relative">
        {{ _dropdown_button('user', name) }}
        <div x-show="activeMenu === 'user'" @mousedown.outside="activeMenu = null" class="dropdown-pane w-60 right-0">
          <a href="{{ url_for("user.summary", username=name) }}" class="dropdown-item">
            {{ _('Profile') }}
          </a>
          <a href="{{ url_for("auth.sign_out") }}" class="dropdown-item">
            {{ _('Sign out') }}
          </a>
        </div>
      </div>
      {% else %}
        <a href="{{ url_for("auth.sign_in") }}" class="{{ button_css }}">{{ _('Sign in') }}</a>
      {% endif %}
    </div>
  </nav>

  {# Unified menu bar: project info, image controls, text controls #}
  <div class="flex-shrink-0 bg-slate-300 border-b text-sky-900 text-sm">
    <div class="flex items-center justify-between p-2 gap-4">
      {# Left side: Project info and page status #}
      <div class="flex-shrink-0">
        <div class="mb-1">
          <a class="block font-bold hover:underline" href="{{ url_for("proofing.project.summary", slug=project.slug) }}">
            {{ project.display_title }}
          </a>
          <div class="text-slate-600 text-xs">Page {{ image_number }} of {{ page_context.num_pages }}</div>
        </div>
      </div>

      {# Middle panel: image and text controls #}
      <div class="flex items-center gap-3 flex-1">
        <div class="flex items-center gap-2">
          {% set status = page_context.cur.status.name %}
          {% if status == 'reviewed-0' %}
          <span class="p-1 rounded text-xs {{ m.revision_colors(status) }}">{{ _('Needs work') }}</span>
          {% elif status == 'reviewed-1' %}
          <span class="p-1 rounded text-xs {{ m.revision_colors(status) }}">{{ _('Proofed once') }}</span>
          {% elif status == 'reviewed-2' %}
          <span class="p-1 rounded text-xs {{ m.revision_colors(status) }}">{{ _('Proofed twice') }}</span>
          {% elif status == 'skip' %}
          <span class="p-1 rounded text-xs {{ m.revision_colors(status) }}">{{ _('Not relevant') }}</span>
          {% endif %}
        </div>

        <div class="border border-slate-300 rounded-full px-3 py-1 bg-slate-50">
          <div class="flex items-center gap-1">
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="increaseTextSize()" title="Increase text size">A<sup>+</sup></button>
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="resetTextSize()" title="Reset text size">A<sup>&#x00b0;</sup></button>
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="decreaseTextSize()" title="Decrease text size">A<sup>-</sup></button>
          </div>
        </div>

        <div class="border border-slate-300 rounded-full px-3 py-1 bg-slate-50">
          <div class="flex items-center gap-1">
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="increaseImageZoom" title="Zoom in">&#x1f50d;<sup>+</sup></button>
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="resetImageZoom" title="Reset zoom">&#x1f50d;&#x00b0;</button>
            <button type="button" class="p-1 hover:bg-slate-200 rounded" @click="decreaseImageZoom" title="Zoom out">&#x1f50d;<sup>-</sup></button>
            <button type="button" id="osd-rotate-left" class="p-1 hover:bg-slate-200 rounded" title="Rotate left">&#x27f2;</button>
            <button type="button" id="osd-rotate-right" class="p-1 hover:bg-slate-200 rounded" title="Rotate right">&#x27f3;</button>
          </div>
        </div>
      </div>

      {# Right side: Navigation and auth #}
      <div class="flex items-center space-x-4 flex-shrink-0">
        <div class="flex items-center gap-2">
          {% set prev_url = url_for('proofing.page.edit', project_slug=project.slug, page_slug=page_context.prev.slug) %}
          {% set next_url = url_for('proofing.page.edit', project_slug=project.slug, page_slug=page_context.next.slug) %}
          <a class="p-2 rounded hover:bg-slate-400" href="{{ prev_url }}">&larr;</a>
          <a class="p-2 rounded hover:bg-slate-400" href="{{ next_url }}">&rarr;</a>
          {% if current_user.is_authenticated %}
          <button class="btn btn-submit px-3 py-1.5"
                  type="button"
                  @click="openSubmitModal">
            {{ _('Save') }}
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if not current_user.is_authenticated -%}
  {% set url = url_for('auth.register') %}
  <div class="px-4 py-2 bg-yellow-100 border-b">
    {% trans %}
    Since you are not logged in, some functions (such as the OCR button) have
    been disabled. To use all website features, please <a class="underline"
    href="{{ url }}">create an account</a>.
    {% endtrans %}
  </div>
  {%- endif %}

  {{ mc.flash_messages() }}

  {% if conflict %}
  <div class="px-4 py-2 bg-slate-100 border-b">
    <pre class="p-2">{{ conflict.content }}</pre>
  </div>
  {% endif %}

  {% if not has_edits %}
    {# i18n: This should match the "Tools" and "Run OCR" translations in the proofing tool. #}
    {% set command = _("Tools &rarr; Run OCR") %}
    <div class="px-4 py-2 bg-blue-100 border-b text-xs">
      {% trans %}
      This page has not been edited yet. Run <i>{{ command }}</i> to get started.
      {% endtrans %}
    </div>
  {% endif %}

  <div x-show="isRunningOCR || isRunningLLMStructuring || isRunningStructuring"
       class="bg-blue-100 border-b text-blue-700 px-4 py-2 text-sm"
       role="alert">
    <span x-show="isRunningOCR">{{ _('Running OCR ...') }}</span>
    <span x-show="isRunningLLMStructuring">{{ _('Running LLM structuring ...') }}</span>
    <span x-show="isRunningStructuring">{{ _('Running structuring ...') }}</span>
  </div>

  <div x-show="xmlParseError"
       class="bg-red-100 border-b text-red-700 px-4 py-2 text-sm flex justify-between items-center"
       role="alert">
    <span x-text="xmlParseError"></span>
    <button type="button"
            class="text-red-700 hover:text-red-900 font-bold ml-4"
            @click="xmlParseError = null">&times;</button>
  </div>

  <form method="POST" class="flex-1 flex flex-col min-h-0" @submit.prevent="submitForm">
    {{ form.csrf_token }}
    {{ form.version }}
    <input type="hidden" name="summary" value="">
    <input type="hidden" name="status" value="{{ form.status.data }}">

    <div :class="layoutClasses" class="flex-1 min-h-0">
      <div class="flex-1 flex flex-col min-h-0">
        <div class="border border-r-slate-400 flex flex-col min-h-0 h-full">
          <div class="p-2 md:p-4 flex-1 min-h-0 overflow-y-scroll">
            <div id="prosemirror-editor" class="prosemirror-editor"></div>
            <textarea id="content" name="content" required="" style="display: none;">{{ form.content.data }}</textarea>
          </div>
        </div>
      </div>
      <div class="flex-1 flex flex-col min-h-0">
        <div class="flex flex-col min-h-0 h-full border bg-slate-100">
          <div id="osd-image" class="flex-1 min-h-0">
          </div>
        </div>
      </div>
    </div>
  </form>

  <div x-show="activeModal === 'command-palette'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden text-sm">
      <input id="command-palette-input"
             type="text"
             :value="commandPaletteQuery"
             @input="updateCommandPaletteQuery($event.target.value)"
             @keydown="handleCommandPaletteKeydown"
             placeholder="Search commands ..."
             class="w-full p-3 focus:outline-none">
      <div class="max-h-96 overflow-y-scroll">
        <template x-for="(cmd, index) in getFilteredCommands()" :key="index">
          <button type="button"
                  @click="executeCommand(index)"
                  :class="index === commandPaletteSelected ? 'bg-blue-100' : 'hover:bg-slate-50'"
                  class="block w-full text-left p-3"
                  x-text="cmd.label">
          </button>
        </template>
      </div>
    </div>
  </div>

  <div x-show="activeModal === 'history'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
      <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-bold">{{ _('Revision history') }}</h2>
        <button type="button"
                class="text-slate-700 hover:text-slate-900 font-bold text-xl"
                @click="closeModal">&times;</button>
      </div>
      <div class="p-4 max-h-96 overflow-y-scroll">
        <div x-show="historyLoading" class="text-center py-4">{{ _('Loading...') }}</div>
        <div x-show="!historyLoading && historyRevisions.length === 0" class="text-center py-4 text-slate-500">
          {{ _('There are no revisions for this page.') }}
        </div>
        <ul x-show="!historyLoading && historyRevisions.length > 0" class="a-hover-underline">
          <template x-for="r in historyRevisions" :key="r.id">
            <li class="my-2 text-sm">
              <span :class="getRevisionColorClass(r.status)" class="inline-block w-2 h-2 mr-0.5 rounded-full"></span>
              <a :href="r.revision_url" class="text-slate-400" x-text="r.created"></a>
              by <a :href="r.author_url" x-text="r.author"></a>
              <i x-show="r.summary" x-text="'(' + r.summary + ')'"></i>
            </li>
          </template>
        </ul>
      </div>
    </div>
  </div>

  <div x-show="activeModal === 'submit'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl overflow-hidden">
      <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-bold">{{ _('Save changes') }}</h2>
        <button type="button"
                class="text-slate-700 hover:text-slate-900 font-bold text-xl"
                @click="closeModal">&times;</button>
      </div>
      <div class="p-4 max-h-[60vh] overflow-y-scroll">
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-slate-700 mb-2">{{ _('Changes made:') }}</h3>
          <div class="bg-slate-50 border border-slate-300 rounded p-3 text-sm font-mono max-h-48 overflow-y-auto whitespace-pre-wrap" x-html="changesPreview"></div>
        </div>

        <div class="flex gap-4 items-end">
          <div class="flex-1">
            {{ form.summary.label(class_="text-slate-600 mb-1 block text-sm") }}
            <input type="text"
                   x-model="modalSummary"
                   class="block rounded bg-white w-full p-2 border border-slate-300"
                   placeholder="{{ _('Fixed various OCR errors') }}">
          </div>

          <div class="flex-1">
            {{ form.status.label(class_="block text-slate-600 mb-1 text-sm") }}
            <select x-model="modalStatus"
                    :class="{
                      'bg-red-200 text-red-800 border-red-300': modalStatus === 'reviewed-0',
                      'bg-yellow-200 text-yellow-800 border-yellow-300': modalStatus === 'reviewed-1',
                      'bg-green-200 text-green-800 border-green-300': modalStatus === 'reviewed-2',
                      'bg-slate-100 text-gray-800 border-gray-300': modalStatus === 'skip'
                    }"
                    class="block w-full p-2 rounded border-2 transition-colors">
              {% set radios = form.status|list %}
              <option value="{{ radios[0].data }}">{{ radios[0].label.text }}</option>
              <option value="{{ radios[1].data }}">{{ radios[1].label.text }}</option>
              {% if not is_r0 %}
              <option value="{{ radios[2].data }}">{{ radios[2].label.text }}</option>
              {% endif %}
              <option value="{{ radios[3].data }}">{{ radios[3].label.text }}</option>
            </select>
          </div>
        </div>

        {% set cc0 = "https://creativecommons.org/publicdomain/zero/1.0/" %}
        <p class="mt-4 text-xs text-slate-600">{% trans %}
        By saving your changes, you agree to release your contribution under the
        <a class="underline" href="{{ cc0 }}">CC0 (public domain) license</a>.
        {% endtrans %}</p>
      </div>

      <div class="bg-slate-100 p-4 border-t flex justify-end gap-3">
        <button type="button"
                class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-200"
                @click="closeModal">
          {{ _('Cancel') }}
        </button>
        <button type="button"
                class="btn btn-submit"
                @click="submitFormFromModal">
          {{ _('Submit my changes') }}
        </button>
      </div>
    </div>
  </div>

  <div x-show="activeModal === 'normalize'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
      <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-bold">{{ _('Normalize Text') }}</h2>
        <button type="button"
                class="text-slate-700 hover:text-slate-900 font-bold text-xl"
                @click="closeModal">&times;</button>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-600 mb-4">{{ _('Select the normalizations to apply to the selected text:') }}</p>

        <div class="space-y-3">
          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="normalizeReplaceColonVisarga" class="w-4 h-4">
            <span class="text-sm">{{ _('Replace : (colon) with ः (visarga)') }}</span>
          </label>

          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="normalizeReplaceSAvagraha" class="w-4 h-4">
            <span class="text-sm">{{ _('Replace S with ऽ (avagraha)') }}</span>
          </label>

          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="normalizeReplaceDoublePipe" class="w-4 h-4">
            <span class="text-sm">{{ _('Replace || with ॥ (double danda)') }}</span>
          </label>
        </div>
      </div>

      <div class="bg-slate-100 p-4 border-t flex justify-end gap-3">
        <button type="button"
                class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-200"
                @click="closeModal">
          {{ _('Cancel') }}
        </button>
        <button type="button"
                class="btn btn-submit"
                @click="applyNormalization">
          {{ _('Normalize') }}
        </button>
      </div>
    </div>
  </div>

  <div x-show="activeModal === 'transliterate'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
      <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-bold">{{ _('Transliterate Text') }}</h2>
        <button type="button"
                class="text-slate-700 hover:text-slate-900 font-bold text-xl"
                @click="closeModal">&times;</button>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-600 mb-4">{{ _('Transliterate the selected text:') }}</p>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">{{ pgettext('editor', 'From:') }}</label>
            <select class="w-full p-2 border border-slate-300 rounded" x-model="fromScript">
              <option value="hk">Harvard-Kyoto ("aGka" &rarr; {{ 'aGka'|d }})</option>
              <option value="itrans">ITRANS ("a~Nka" &rarr; {{ 'aGka'|d }})</option>
              <option value="optitrans">OPTITRANS ("anka" &rarr; {{ 'aGka'|d }})</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">{{ pgettext('editor', 'To:') }}</label>
            <select class="w-full p-2 border border-slate-300 rounded" x-model="toScript">
              <option value="devanagari">{{ _('Devanagari') }}</option>
              <option value="iast">{{ _('IAST') }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="bg-slate-100 p-4 border-t flex justify-end gap-3">
        <button type="button"
                class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-200"
                @click="closeModal">
          {{ _('Cancel') }}
        </button>
        <button type="button"
                class="btn btn-submit"
                @click="applyTransliteration">
          {{ _('Transliterate') }}
        </button>
      </div>
    </div>
  </div>

  <div x-show="activeModal === 'auto-structure'"
       x-cloak
       @click.self="closeModal"
       @keydown.window.escape="closeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
      <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-bold">{{ _('Auto-structure') }}</h2>
        <button type="button"
                class="text-slate-700 hover:text-slate-900 font-bold text-xl"
                @click="closeModal">&times;</button>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-600 mb-4">{{ _('Select the elements to automatically structure:') }}</p>

        <div class="space-y-3">
          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="autoStructureStageDirections" class="w-4 h-4">
            <span class="text-sm">{{ _('Stage directions (...)') }}</span>
          </label>

          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="autoStructureSpeakers" class="w-4 h-4">
            <span class="text-sm">{{ _('Speakers (^.*[-])') }}</span>
          </label>

          <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
            <input type="checkbox" x-model="autoStructureChaya" class="w-4 h-4">
            <span class="text-sm">{{ _('Chaya [...]') }}</span>
          </label>
        </div>
      </div>

      <div class="bg-slate-100 p-4 border-t flex justify-end gap-3">
        <button type="button"
                class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-200"
                @click="closeModal">
          {{ _('Cancel') }}
        </button>
        <button type="button"
                class="btn btn-submit"
                @click="applyAutoStructure">
          {{ _('Auto-structure') }}
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1/build/openseadragon/openseadragon.min.js"></script>
<script type="text/javascript">
const IMAGE_URL = "{{ image_url }}";
const OCR_BOUNDING_BOXES = {{ cur.ocr_bounding_boxes|tojson|safe }};
</script>
{% endblock %}
