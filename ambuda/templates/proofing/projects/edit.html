{% extends 'proofing/base-sidebar.html' %}
{% import "macros/components.html" as components %}
{% import "macros/forms.html" as mf %}
{% import "macros/proofing.html" as m %}


{% block title %}Edit: {{ project.display_title }} | Ambuda{% endblock %}


{% block sidebar %}{{ m.main_nav('projects', current_user=current_user) }}{% endblock %}


{% block content %}
{{ m.project_header_nested('Edit', project) }}
{{ m.project_tabs(project=project, active='edit', is_mod=current_user.is_moderator) }}

{% set ocr_url = url_for("proofing.project.batch_ocr", slug=project.slug)  %}
{% set editing_url = url_for("proofing.project.batch_editing", slug=project.slug)  %}

<div class="prose">

<ul>
  <li><a href="{{ ocr_url }}">{{ _('Run batch OCR') }}</a></li>
  <li><a href="{{ editing_url }}">{{ _('Run batch editing') }}</a></li>
</ul>

{{ components.flash_messages() }}
{{ mf.show_errors_if_any(form.errors) }}

<form method="POST">
  {{ form.csrf_token }}

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Basic information</legend>
    <div class="bg-slate-100 p-4">
      {{ mf.field(form.display_title) }}
      <div class="my-2">
        {{ mf.label(form.slug.label) }}
        <div class="flex gap-2">
          {{ form.slug(class_="p-2 block w-full my-2", id="slug-field") }}
          <button type="button" class="btn btn-secondary whitespace-nowrap" onclick="regenerateSlug()">{{ _('Regenerate') }}</button>
        </div>
      </div>
      {% if current_user.is_p2 %}
        {{ mf.field(form.status) }}
      {% endif %}
      {{ mf.field(form.genre) }}
      {{ mf.markdown_field(form.description) }}
      {{ mf.field(form.page_numbers) }}
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Book metadata</legend>
    <div class="bg-slate-100 p-4">
      {{ mf.field(form.print_title) }}
      {{ mf.field(form.author) }}
      {{ mf.field(form.editor) }}
      {{ mf.field(form.publisher) }}
      {{ mf.field(form.publication_year) }}
      {{ mf.field(form.worldcat_link) }}
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Internal notes</legend>
    <div class="bg-slate-100 p-4">
      {{ mf.field(form.notes) }}
    </div>
  </fieldset>

  <input class="btn btn-submit mt-4" type="submit" value="{{ _('Save changes') }}">
</form>

<script>
function regenerateSlug() {
  const titleField = document.getElementById('display_title');
  const slugField = document.getElementById('slug-field');

  if (!titleField || !slugField) return;

  const title = titleField.value;

  // Generate slug: strip, lowercase, replace whitespace/special chars with hyphens
  let slug = title
    .trim()
    .toLowerCase()
    // Replace any sequence of whitespace with a single hyphen
    .replace(/\s+/g, '-')
    // Remove diacritics and special characters (keep only alphanumeric and hyphens)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    // Replace any non-alphanumeric characters (except hyphens) with hyphens
    .replace(/[^a-z0-9-]/g, '-')
    // Replace multiple consecutive hyphens with a single hyphen
    .replace(/-+/g, '-')
    // Remove leading/trailing hyphens
    .replace(/^-+|-+$/g, '');

  slugField.value = slug;
}
</script>

{% endblock %}
