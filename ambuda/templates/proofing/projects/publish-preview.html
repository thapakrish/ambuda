{% extends 'proofing/base-sidebar.html' %}
{% import "macros/components.html" as components %}
{% import "macros/proofing.html" as m %}


{% block title %}Publish Preview: {{ project.display_title }} | Ambuda{% endblock %}


{% block sidebar %}{{ m.main_nav('projects', current_user=current_user) }}{% endblock %}

{% block extra_head %}
<style>
  .diff-content ins {
    background-color: #d4edda;
    text-decoration: none;
    font-weight: 600;
  }
  .diff-content del {
    background-color: #f8d7da;
    text-decoration: line-through;
  }
</style>
{% endblock %}


{% block content %}
{{ components.flash_messages() }}

{{ m.project_header_nested('Publish Preview', project) }}
{{ m.project_tabs(project=project, active='publish', is_mod=current_user.is_moderator) }}

<div class="prose max-w-none">
  <h2>Preview Changes</h2>

  <p>
    Review the changes that will be made when you publish. New texts will be created, and existing texts will be updated.
  </p>

  {% for preview in previews %}
  <div class="not-prose border border-slate-300 rounded p-4 mb-6">
    <div class="mb-4">
      <h3 class="text-xl font-bold">
        {{ preview.title }}
        {% if preview.is_new %}
        <span class="inline-block ml-2 px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">NEW</span>
        {% else %}
        <span class="inline-block ml-2 px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800">UPDATE</span>
        {% endif %}
      </h3>
      <p class="text-sm text-slate-600">
        Slug: <code>{{ preview.slug }}</code> | Target: <code>{{ preview.target }}</code>
      </p>
    </div>

    {% if preview.is_new %}
    <div class="bg-green-50 border border-green-200 rounded p-3 mb-3">
      <p class="font-semibold text-green-800 mb-2">Creating New Text</p>
      <p class="text-sm text-slate-700">
        This will create a new text with {{ preview.diffs|length }} blocks.
      </p>
    </div>
    {% else %}
    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
      <p class="font-semibold text-blue-800 mb-2">Updating Existing Text</p>
      <p class="text-sm text-slate-700">
        {% if preview.diffs|length == 0 %}
        No changes detected.
        {% else %}
        {{ preview.diffs|length }} block(s) changed.
        {% endif %}
      </p>
    </div>
    {% endif %}

    {% if preview.diffs|length > 0 %}
    <details class="mb-3" {% if not preview.is_new %}open{% endif %}>
      <summary class="cursor-pointer font-semibold text-sm text-slate-700 hover:text-slate-900">
        View changes ({{ preview.diffs|length }} block{{ 's' if preview.diffs|length != 1 else '' }})
      </summary>
      <div class="mt-2 max-h-96 overflow-y-auto space-y-3">
        {% for diff in preview.diffs %}
        <div class="border rounded p-3 {% if diff.type == 'added' %}bg-green-50 border-green-200{% elif diff.type == 'removed' %}bg-red-50 border-red-200{% else %}bg-yellow-50 border-yellow-200{% endif %}">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-mono text-slate-600">Block #{{ loop.index }}</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded {% if diff.type == 'added' %}bg-green-200 text-green-900{% elif diff.type == 'removed' %}bg-red-200 text-red-900{% else %}bg-yellow-200 text-yellow-900{% endif %}">
              {{ diff.type|upper }}
            </span>
          </div>
          <pre class="diff-content text-sm font-mono whitespace-pre-wrap {% if diff.type == 'added' %}text-green-900{% elif diff.type == 'removed' %}text-red-900{% else %}text-slate-900{% endif %}">
            {{- diff.diff|safe -}}
          </pre >
        </div>
        {% endfor %}
      </div>
    </details>
    {% endif %}
  </div>
  {% endfor %}

  <form method="POST" action="{{ url_for('proofing.project.publish_create', slug=project.slug) }}" class="not-prose mt-6 pt-4 border-t border-slate-300">
    <div class="flex gap-3">
      <button type="submit" class="btn btn-primary">
        Publish
      </button>
    </div>

    <p class="text-sm text-slate-600 mt-3">
      This action will create new texts or update existing ones with the content shown above.
    </p>
  </form>
</div>

{% endblock %}
