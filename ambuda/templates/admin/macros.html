{#- Flash message display macro -#}
{% macro flash_messages() %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="mb-4 p-3 rounded text-sm {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
{% endmacro %}

{#- Render a form field with appropriate styling -#}
{% macro render_field(field, read_only=false, fk_target=none) %}
  <div class="mb-4">
    <label for="{{ field.id }}" class="block text-sm font-semibold text-slate-700 mb-1">
      {{ field.label.text }}
      {% if fk_target %}
        <a href="{{ url_for('admin.create_model', model_name=fk_target) }}"
           class="ml-1 text-sky-600 hover:text-sky-700 font-bold text-base"
           title="Create new {{ fk_target }}"
           target="_blank">+</a>
      {% endif %}
    </label>

    {% if field.type == 'TextAreaField' %}
      {{ field(class="w-full px-3 py-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500", rows=5, disabled=read_only) }}
    {% elif field.type == 'BooleanField' %}
      <div class="flex items-center">
        {{ field(class="w-4 h-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500", disabled=read_only) }}
        <span class="ml-2 text-sm text-slate-600">{{ field.label.text }}</span>
      </div>
    {% elif field.type == 'SelectField' %}
      {{ field(class="w-full px-3 py-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500", disabled=read_only) }}
    {% elif field.type == 'SelectMultipleField' %}
      <div class="text-xs text-slate-500 mb-1">Hold <kbd>Ctrl</kbd> (<kbd>Cmd</kbd> on Mac) to select multiple items</div>
      {{ field(class="w-full px-3 py-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500", disabled=read_only) }}
    {% elif field.type == 'DateTimeLocalField' %}
      <div class="text-xs text-slate-500 mb-1">Enter time in UTC</div>
      {{ field(type="datetime-local", class="w-full px-3 py-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500", disabled=read_only) }}
    {% else %}
      {{ field(class="w-full px-3 py-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500", disabled=read_only) }}
    {% endif %}

    {% if field.errors %}
      {% for error in field.errors %}
        <p class="mt-1 text-sm text-red-600">{{ error }}</p>
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

{#- Dynamic file metadata fields JavaScript -#}
{% macro file_metadata_script(file_input_id, slug_label='Slug', title_label='Title') %}
<script>
  (function() {
    const fileInput = document.getElementById('{{ file_input_id }}');
    const container = document.getElementById('file-metadata-container');

    function deriveSlug(filename) {
      return filename.replace(/\.xml$/i, '');
    }

    function deriveTitle(slug) {
      return slug.replace(/[-_]/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function updateFileMetadataFields() {
      const files = fileInput.files;

      if (files.length === 0) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }

      container.classList.remove('hidden');
      container.innerHTML = '';

      Array.from(files).forEach((file, index) => {
        const slug = deriveSlug(file.name);
        const title = deriveTitle(slug);

        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
        fieldGroup.innerHTML = `
          <div class="mb-3">
            <p class="text-sm font-semibold text-slate-700 mb-2">File: ${file.name}</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="slug_${index}" class="block text-xs font-semibold text-slate-700 mb-1">
                {{ slug_label }}
              </label>
              <input
                type="text"
                id="slug_${index}"
                name="slug_${index}"
                value="${slug}"
                required
                class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500"
              />
            </div>
            <div>
              <label for="title_${index}" class="block text-xs font-semibold text-slate-700 mb-1">
                {{ title_label }}
              </label>
              <input
                type="text"
                id="title_${index}"
                name="title_${index}"
                value="${title}"
                required
                class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-sky-500"
              />
            </div>
          </div>
        `;
        container.appendChild(fieldGroup);
      });
    }

    fileInput.addEventListener('change', updateFileMetadataFields);
  })();
</script>
{% endmacro %}
